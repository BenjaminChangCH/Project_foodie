# app_streamlit.py

import streamlit as st
import io # ç”¨æ–¼è™•ç†åœ–ç‰‡ä¸Šå‚³çš„ä½å…ƒçµ„æµ

# åŒ¯å…¥æˆ‘å€‘è‡ªå·±å»ºç«‹çš„ vision_api æ¨¡çµ„
# å‡è¨­æ‚¨çš„ vision_api.py æª”æ¡ˆä½æ–¼åç‚º 'vision_module' çš„è³‡æ–™å¤¾ä¸­ï¼Œ
# ä¸¦ä¸” 'vision_module' è³‡æ–™å¤¾èˆ‡ 'app_streamlit.py' åœ¨åŒä¸€å±¤ç´š (éƒ½åœ¨ 'project_foodie' å…§)ã€‚
# å¦‚æœæ‚¨çš„è³‡æ–™å¤¾åç¨±ä¸åŒ (ä¾‹å¦‚æ‚¨ä¹‹å‰ä½¿ç”¨çš„æ˜¯ 'Õƒ<y_bin_46>python_code')ï¼Œè«‹ç›¸æ‡‰ä¿®æ”¹ 'vision_module'ã€‚
try:
    from vision_module import vision_api 
except ImportError as e:
    # å¦‚æœåŒ¯å…¥å¤±æ•—ï¼Œå¾ˆå¯èƒ½æ˜¯æª”æ¡ˆè·¯å¾‘æˆ–åç¨±æœ‰å•é¡Œ
    st.error(f"éŒ¯èª¤ï¼šç„¡æ³•åŒ¯å…¥ vision_api æ¨¡çµ„: {e}ã€‚"
             "è«‹ç¢ºèª 'vision_module/vision_api.py' (æˆ–æ‚¨å¯¦éš›çš„æ¨¡çµ„è·¯å¾‘) æª”æ¡ˆå­˜åœ¨ï¼Œä¸¦ä¸”è³‡æ–™å¤¾çµæ§‹æ­£ç¢ºã€‚")
    st.stop() # åœæ­¢æ‡‰ç”¨ç¨‹å¼åŸ·è¡Œï¼Œå› ç‚ºæ ¸å¿ƒæ¨¡çµ„ç„¡æ³•è¼‰å…¥

# è¨­å®šç¶²é çš„æ¨™é¡Œå’Œä½ˆå±€æ–¹å¼
st.set_page_config(page_title="AI é£Ÿç‰©åŠ©æ‰‹ (Vision API æ¸¬è©¦)", layout="wide")
st.title("ğŸ“¸ AI é£Ÿç‰©åœ–ç‰‡åˆ†æåŠ©æ‰‹")
st.subheader("ä½¿ç”¨ Google Cloud Vision API")

# --- éå¸¸é‡è¦ï¼šåœ¨æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•æ™‚ï¼Œå‘¼å«ä¸€æ¬¡æ†‘è­‰è¨­å®šå‡½å¼ ---
# é€™æœƒåŸ·è¡Œ vision_api.py ä¸­çš„ setup_google_credentials()ï¼Œ
# å˜—è©¦å¾ .streamlit/secrets.toml (æœ¬åœ°) æˆ– Streamlit Cloud Secrets (éƒ¨ç½²æ™‚) è®€å–é‡‘é‘°å…§å®¹ï¼Œ
# ä¸¦è¨­å®šå¥½ç’°å¢ƒè®Šæ•¸ï¼Œä»¥ä¾¿ google-cloud-vision å¥—ä»¶å¯ä»¥æ‰¾åˆ°æ†‘è­‰ã€‚
if hasattr(vision_api, 'setup_google_credentials'): # æª¢æŸ¥å‡½å¼æ˜¯å¦å­˜åœ¨æ–¼æ¨¡çµ„ä¸­
    vision_api.setup_google_credentials()
else:
    st.error("åš´é‡éŒ¯èª¤ï¼š'setup_google_credentials' å‡½å¼åœ¨ vision_api æ¨¡çµ„ä¸­æœªå®šç¾©ã€‚æ‡‰ç”¨ç¨‹å¼ç„¡æ³•ç¹¼çºŒã€‚")
    st.stop() # å¦‚æœæ ¸å¿ƒçš„æ†‘è­‰è¨­å®šå‡½å¼ä¸å­˜åœ¨ï¼Œå‰‡åœæ­¢æ‡‰ç”¨ç¨‹å¼
# ---------------------------------------------------------------

# å´é‚Šæ¬„çš„èªªæ˜æ–‡å­—
st.sidebar.header("ä½¿ç”¨èªªæ˜")
st.sidebar.info(
    """
    1.  é»æ“Šä¸‹æ–¹çš„ã€Œç€è¦½æª”æ¡ˆã€æŒ‰éˆ•ï¼Œæˆ–ç›´æ¥å°‡åœ–ç‰‡æ‹–æ”¾åˆ°è©²å€åŸŸï¼Œä»¥ä¸Šå‚³ä¸€å¼µåŒ…å«é£Ÿç‰©çš„åœ–ç‰‡ã€‚
    2.  åœ–ç‰‡ä¸Šå‚³æˆåŠŸå¾Œï¼Œå®ƒæœƒé¡¯ç¤ºåœ¨é é¢å·¦å´ã€‚
    3.  é»æ“Šå³å´çš„ã€Œé–‹å§‹åˆ†æåœ–ç‰‡ã€æŒ‰éˆ•ã€‚
    4.  æ‡‰ç”¨ç¨‹å¼å°‡ä½¿ç”¨ Google Cloud Vision API ä¾†è¾¨è­˜åœ–ç‰‡ä¸­çš„ä¸»è¦é£Ÿç‰©å…§å®¹æ¨™ç±¤ã€‚
    """
)

# åœ¨å´é‚Šæ¬„é¡¯ç¤ºä¸€å€‹è­¦å‘Šï¼Œå¦‚æœæ†‘è­‰è¨­å®šä¸æˆåŠŸ
# vision_api._google_credentials_set æ˜¯æˆ‘å€‘åœ¨ vision_api.py ä¸­è¨­å®šçš„å…¨åŸŸè®Šæ•¸ï¼Œç”¨ä¾†è¿½è¹¤æ†‘è­‰ç‹€æ…‹
if hasattr(vision_api, '_google_credentials_set') and not vision_api._google_credentials_set:
    st.sidebar.error(
        "è­¦å‘Šï¼šGCP æ†‘è­‰æœªèƒ½æˆåŠŸè¼‰å…¥ã€‚åœ–ç‰‡åˆ†æåŠŸèƒ½å¯èƒ½ç„¡æ³•ä½¿ç”¨ã€‚ "
        "è«‹æª¢æŸ¥æ‚¨çš„ `.streamlit/secrets.toml` æª”æ¡ˆä¸­çš„ 'GCP_CREDENTIALS_JSON_CONTENT' é …ç›®ï¼Œ"
        "æˆ–ç›¸é—œçš„ GCP è¨­å®šèˆ‡é‡‘é‘°æ¬Šé™ã€‚",
        icon="âš ï¸"
    )

# --- ä¸»æ‡‰ç”¨ç¨‹å¼ä»‹é¢ ---
# æª”æ¡ˆä¸Šå‚³å…ƒä»¶
uploaded_file = st.file_uploader(
    "1. è«‹ä¸Šå‚³é£Ÿç‰©åœ–ç‰‡é€²è¡Œåˆ†æ:", 
    type=["jpg", "jpeg", "png"], # é™åˆ¶å¯ä¸Šå‚³çš„æª”æ¡ˆé¡å‹ç‚ºé€™ä¸‰ç¨®åœ–ç‰‡æ ¼å¼
    help="å°‡åœ–ç‰‡æ‹–æ”¾åˆ°æ­¤è™•ï¼Œæˆ–é»æ“Šç€è¦½æª”æ¡ˆã€‚æ”¯æ´ JPG, JPEG, PNG æ ¼å¼ã€‚" # æ»‘é¼ ç§»åˆ°ä¸Šå‚³å€åŸŸæ™‚é¡¯ç¤ºçš„è¼”åŠ©èªªæ˜æ–‡å­—
)

if uploaded_file is not None: # å¦‚æœä½¿ç”¨è€…å·²æˆåŠŸä¸Šå‚³æª”æ¡ˆ
    image_bytes = uploaded_file.getvalue() # ç²å–ä¸Šå‚³åœ–ç‰‡çš„åŸå§‹ä½å…ƒçµ„æ•¸æ“š

    # ä½¿ç”¨ st.columns å°‡é é¢åˆ†ç‚ºå…©æ¬„ï¼Œè®“åœ–ç‰‡å’Œçµæœä¸¦æ’é¡¯ç¤ºï¼Œä½ˆå±€æ›´ç¾è§€
    col1, col2 = st.columns([0.6, 0.4]) # å·¦æ¬„ä½” 60% å¯¬åº¦ï¼Œå³æ¬„ä½” 40%

    with col1: # åœ¨å·¦æ¬„é¡¯ç¤ºä¸Šå‚³çš„åœ–ç‰‡
        st.image(image_bytes, caption="æ‚¨ä¸Šå‚³çš„åœ–ç‰‡", use_column_width=True) # use_column_width=True è®“åœ–ç‰‡å¯¬åº¦ç¬¦åˆæ¬„å¯¬

    with col2: # åœ¨å³æ¬„é¡¯ç¤ºåˆ†ææŒ‰éˆ•å’Œåˆ†æçµæœ
        if st.button("ğŸ” é–‹å§‹åˆ†æåœ–ç‰‡", type="primary", use_container_width=True, key="analyze_button"):
            if image_bytes: # å†æ¬¡ç¢ºèªåœ–ç‰‡æ•¸æ“šå­˜åœ¨ (é€šå¸¸ uploaded_file is not None å°±è¡¨ç¤ºå­˜åœ¨)
                # æª¢æŸ¥ GCP æ†‘è­‰æ˜¯å¦å·²æˆåŠŸè¨­å®š (å¾ vision_api æ¨¡çµ„çš„å…¨åŸŸè®Šæ•¸è®€å–ç‹€æ…‹)
                if not vision_api._google_credentials_set:
                    st.error("ç„¡æ³•é€²è¡Œåˆ†æï¼šGCP æ†‘è­‰å°šæœªæˆåŠŸè¨­å®šã€‚è«‹æª¢æŸ¥æ‚¨çš„ secrets.toml è¨­å®šæˆ–ç¨‹å¼ç¢¼ä¸­çš„æ†‘è­‰è™•ç†é‚è¼¯ã€‚")
                else:
                    # é¡¯ç¤ºè™•ç†ä¸­å‹•ç•« (spinner)ï¼Œä¸¦å‘¼å« vision_api æ¨¡çµ„ä¸­çš„åˆ†æå‡½å¼
                    with st.spinner("åœ–ç‰‡åˆ†æä¸­ï¼Œéç¨‹å¯èƒ½æœƒéœ€è¦å¹¾ç§’é˜ï¼Œè«‹ç¨å€™..."):
                        if hasattr(vision_api, 'analyze_image_labels'): # å†æ¬¡æª¢æŸ¥å‡½å¼æ˜¯å¦å­˜åœ¨æ–¼æ¨¡çµ„ä¸­
                            analysis_results = vision_api.analyze_image_labels(image_bytes)
                        else:
                            st.error("åš´é‡éŒ¯èª¤ï¼š'analyze_image_labels' å‡½å¼åœ¨ vision_api æ¨¡çµ„ä¸­æœªå®šç¾©ã€‚")
                            analysis_results = None # è¨­ç‚º None ä»¥é¿å…å¾ŒçºŒéŒ¯èª¤

                    st.markdown("---") # ç•«ä¸€æ¢åˆ†éš”ç·šï¼Œè®“çµæœæ›´æ¸…æ™°
                    if analysis_results is not None: # å¦‚æœ analyze_image_labels å‡½å¼æˆåŠŸåŸ·è¡Œ (å¯èƒ½è¿”å›ç©ºåˆ—è¡¨ï¼Œæˆ–æœ‰çµæœ)
                        if analysis_results: # å¦‚æœçµæœåˆ—è¡¨ä¸æ˜¯ç©ºçš„ (å³æœ‰è¾¨è­˜åˆ°æ¨™ç±¤)
                            st.subheader("ğŸ‘ï¸ åœ–ç‰‡åˆ†æçµæœ (ä¾†è‡ª Google Vision API):")
                            # è¿­ä»£é¡¯ç¤ºæ¯ä¸€å€‹è¾¨è­˜åˆ°çš„æ¨™ç±¤åŠå…¶ä¿¡è³´åº¦
                            for description, score in analysis_results:
                                # ä¹‹å¾Œæˆ‘å€‘æœƒåœ¨é€™è£¡åŠ å…¥ä¸­æ–‡ç¿»è­¯çš„æ­¥é©Ÿ
                                st.write(f"- **{description}** (ä¿¡è³´åº¦: {score:.1%})") # .1% è¡¨ç¤ºé¡¯ç¤ºç‚ºç™¾åˆ†æ¯”ï¼Œå°æ•¸é»å¾Œä¸€ä½
                        else: # çµæœåˆ—è¡¨æ˜¯ç©ºçš„ (API æˆåŠŸå‘¼å«äº†ï¼Œä½†æ²’è¾¨è­˜å‡ºä»»ä½•å®ƒèªç‚ºç›¸é—œçš„æ¨™ç±¤)
                            st.info("æœªèƒ½å¾åœ–ç‰‡ä¸­åˆ†æå‡ºä»»ä½•é¡¯è‘—çš„æ¨™ç±¤ (Vision API è¿”å›äº†ç©ºçš„çµæœåˆ—è¡¨)ã€‚")
                    # å¦‚æœ analysis_results ç‚º Noneï¼Œè¡¨ç¤ºåœ¨ analyze_image_labels å‡½å¼å…§éƒ¨ç™¼ç”Ÿäº†éŒ¯èª¤ï¼Œ
                    # ä¸”è©²å‡½å¼æ‡‰è©²å·²ç¶“é€é st.error æˆ– print (åœ¨çµ‚ç«¯æ©Ÿé¡¯ç¤º) è™•ç†äº†éŒ¯èª¤è¨Šæ¯çš„æç¤ºã€‚
            else:
                # ç†è«–ä¸Š uploaded_file is not None æ™‚ image_bytes å°±æœƒæœ‰å€¼, ä½†å¤šä¸€å±¤æª¢æŸ¥ç„¡å¦¨
                st.warning("åœ–ç‰‡å…§å®¹ç‚ºç©ºï¼Œè«‹é‡æ–°ä¸Šå‚³ã€‚") 
else: # å¦‚æœä½¿ç”¨è€…é‚„æ²’ä¸Šå‚³æª”æ¡ˆ
    st.info("è«‹å…ˆä¸Šå‚³ä¸€å¼µé£Ÿç‰©åœ–ç‰‡ï¼Œç„¶å¾Œé»æ“Šã€Œé–‹å§‹åˆ†æåœ–ç‰‡ã€æŒ‰éˆ•ã€‚")

st.markdown("---") # é å°¾åˆ†éš”ç·š
st.caption("æ­¤æ‡‰ç”¨ç¨‹å¼ä½¿ç”¨ Google Cloud Vision API é€²è¡Œåœ–ç‰‡å…§å®¹åˆ†æã€‚")